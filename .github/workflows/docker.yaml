name: Pusher

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œ


env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-latest
    steps:
    - name: Start Build Process
      run: |
        echo "### ğŸš€ å¼€å§‹æ„å»ºæµç¨‹" >> $GITHUB_STEP_SUMMARY
        echo "#### â° æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- è§¦å‘äº‹ä»¶: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰§è¡Œåˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ„å»ºç¼–å·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

    - name: System Info Check
      run: |
        echo "### ğŸ’» ç³»ç»Ÿä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "æ“ä½œç³»ç»Ÿ: $(uname -a)" >> $GITHUB_STEP_SUMMARY
        echo "Docker ç‰ˆæœ¬: $(docker --version)" >> $GITHUB_STEP_SUMMARY
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:" >> $GITHUB_STEP_SUMMARY
        df -h | grep -v tmpfs >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Before freeing up disk space
      run: |
        echo "::group::ç£ç›˜ç©ºé—´æ£€æŸ¥ - æ¸…ç†å‰"
        df -hT
        echo "::endgroup::"

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: After Space Cleanup
      run: |
        echo "### ğŸ’¾ ç£ç›˜ç©ºé—´ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "æ¸…ç†åå¯ç”¨ç©ºé—´:" >> $GITHUB_STEP_SUMMARY
        df -h | grep -v tmpfs >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Restart docker
      run: sudo service docker restart

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    # è®°å½•å¼€å§‹æ—¶é—´
    - name: Set start time
      id: start_time
      run: |
        echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Build and push image Aliyun
      id: build_push
      run: |
        # åˆå§‹åŒ–æ—¶é—´å˜é‡
        build_start_time=$(date +%s)
        processed_images=0
        failed_images=0
        attempt=1  # åˆå§‹åŒ– attempt å˜é‡
        
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        echo "Debug: æ˜¾ç¤º images.txt å†…å®¹"
        cat images.txt
        echo "Debug: æ˜¾ç¤ºæ–‡ä»¶ç¼–ç "
        file images.txt
        
        # åœ¨docker loginä¹‹åï¼Œæ‹‰å–é•œåƒä¹‹å‰æ·»åŠ ï¼š
        echo "### ğŸš€ é…ç½®æ„å»ºä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "- å¯ç”¨ BuildKit" >> $GITHUB_STEP_SUMMARY
        echo "- é…ç½®å¹¶è¡Œä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "- å¯ç”¨é•œåƒå±‚ç¼“å­˜" >> $GITHUB_STEP_SUMMARY

        # è®¾ç½® Docker é…ç½®
        echo '{
            "experimental": true,
            "max-concurrent-downloads": 10,
            "max-concurrent-uploads": 10,
            "registry-mirrors": ["https://registry.docker-cn.com"]
        }' | sudo tee /etc/docker/daemon.json

        # é‡å¯ Docker ä½¿é…ç½®ç”Ÿæ•ˆ
        sudo systemctl restart docker

        # è®¾ç½®ç¯å¢ƒå˜é‡
        export DOCKER_BUILDKIT=1
        export DOCKER_CLI_EXPERIMENTAL=enabled
        
        # æ˜¾ç¤ºDockeré…ç½®ç¡®è®¤
        echo "Debug: å½“å‰Dockeré…ç½®:"
        sudo cat /etc/docker/daemon.json

        # æ˜¾ç¤ºDockerä¿¡æ¯
        echo "Debug: Dockerä¿¡æ¯:"
        docker info
        
        # å®šä¹‰æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨çš„å‡½æ•°
        check_image_exists() {
            local image="$1"
            local registry="$2"
            local namespace="$3"
            local repository="$4"
            local tag="$5"
            
            echo "Debug: æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨: $image"
            echo "Debug: ä»“åº“ä¿¡æ¯: $registry/$namespace/$repository:$tag"
            
            # æ„å»ºè®¤è¯å­—ç¬¦ä¸²
            local auth_header="Basic $(echo -n "${ALIYUN_REGISTRY_USER}:${ALIYUN_REGISTRY_PASSWORD}" | base64)"
            
            # ä½¿ç”¨é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡APIæ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
            local check_result
            check_result=$(curl -s -X GET \
                -H "Content-Type: application/json" \
                -H "Authorization: ${auth_header}" \
                "https://${registry}/v2/${namespace}/${repository}/manifests/${tag}" 2>&1)
            
            echo "Debug: APIå“åº”: $check_result"
            
            # æ£€æŸ¥å“åº”çŠ¶æ€å’Œå†…å®¹
            if echo "$check_result" | grep -q "digest"; then
                echo "Debug: é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†"
                return 0
            else
                echo "Debug: é•œåƒä¸å­˜åœ¨æˆ–æ£€æŸ¥å¤±è´¥ï¼Œéœ€è¦å¤„ç†"
                return 1
            fi
        }

        # å®šä¹‰é‡è¯•å‡½æ•°
        retry_command() {
          local cmd="$1"
          local max_attempts=3
          local attempt=1
          local wait_time=10
          local error_msg=""
          local retry_count=0
          
          echo "Debug: æ‰§è¡Œå‘½ä»¤: $cmd"
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯æ¨é€å‘½ä»¤
          if [[ $cmd == *"docker push"* ]]; then
              # æå–é•œåƒåç§°ç”¨äºçŠ¶æ€è·Ÿè¸ª
              local image_name=$(echo "$cmd" | grep -oP 'docker push \K[^ ]+')
              local status_file="/tmp/push_status_${image_name//\//_}.txt"
              
              # è§£æé•œåƒä¿¡æ¯
              local registry=$(echo "$image_name" | cut -d'/' -f1)
              local namespace=$(echo "$image_name" | cut -d'/' -f2)
              local repository_tag=$(echo "$image_name" | cut -d'/' -f3)
              local repository=$(echo "$repository_tag" | cut -d':' -f1)
              local tag=$(echo "$repository_tag" | cut -d':' -f2)
              
              # æ£€æŸ¥æ˜¯å¦å·²ç»æˆåŠŸæ¨é€
              if [ -f "$status_file" ]; then
                  echo "Debug: æœ¬åœ°çŠ¶æ€æ˜¾ç¤ºé•œåƒå·²ç»æˆåŠŸæ¨é€ï¼Œè·³è¿‡"
                  return 0
              fi
              
              # æ£€æŸ¥è¿œç¨‹ä»“åº“æ˜¯å¦å­˜åœ¨ç›¸åŒç‰ˆæœ¬
              if check_image_exists "$image_name" "$registry" "$namespace" "$repository" "$tag"; then
                  echo "Debug: è¿œç¨‹ä»“åº“å·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬é•œåƒï¼Œè·³è¿‡æ¨é€"
                  touch "$status_file"  # æ ‡è®°ä¸ºå·²æ¨é€
                  return 0
              fi
              
              echo "ğŸ”„ å¼€å§‹æ¨é€é•œåƒ..."
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
              push_output_file=$(mktemp)
              push_success=false
              
              # æ‰§è¡Œæ¨é€å‘½ä»¤å¹¶ä¿å­˜è¾“å‡º
              if eval "$cmd" 2>&1 | tee "$push_output_file" | while IFS= read -r line; do
                  # åªå¤„ç†åŒ…å«è¿›åº¦ä¿¡æ¯çš„è¡Œ
                  if [[ $line =~ ^[0-9a-f]+:\ (Push|Layer)\ progress:\ ([0-9]+)% ]]; then
                      progress="${BASH_REMATCH[2]}"
                      echo -ne "\rğŸ“¦ æ¨é€è¿›åº¦: ${progress}% "
                  elif [[ $line =~ digest:\ ([a-zA-Z0-9:]+) ]]; then
                      echo -e "\nâœ… æ¨é€å®Œæˆ: ${BASH_REMATCH[1]}"
                      push_success=true
                  fi
              done; then
                  # æ£€æŸ¥æ˜¯å¦æˆåŠŸæ¨é€
                  if [[ $push_success == true ]] || grep -q "digest: sha" "$push_output_file"; then
                      echo "âœ… é•œåƒæ¨é€æˆåŠŸ"
                      # æ ‡è®°æ¨é€æˆåŠŸ
                      touch "$status_file"
                      # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                      rm -f "$push_output_file"
                      return 0
                  fi
              fi
              
              # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
              rm -f "$push_output_file"
              return 1
          else
              # æ™®é€šå‘½ä»¤æ‰§è¡Œ
              if eval "$cmd" > /tmp/output.log 2> /tmp/error.log; then
                  echo "Debug: å‘½ä»¤è¾“å‡º:"
                  cat /tmp/output.log
                  echo "Debug: é”™è¯¯è¾“å‡º:"
                  cat /tmp/error.log
                  retry_count=$((attempt-1))
                  return 0
              else
                  local exit_code=$?
                  error_msg=$(cat /tmp/error.log)
                  echo "::warning::å‘½ä»¤æ‰§è¡Œå¤±è´¥ (å°è¯• $attempt/$max_attempts)"
                  echo "Debug: é€€å‡ºä»£ç : $exit_code"
                  echo "Debug: å‘½ä»¤è¾“å‡º:"
                  cat /tmp/output.log
                  echo "Debug: é”™è¯¯è¾“å‡º:"
                  cat /tmp/error.log
                  if [ $attempt -lt $max_attempts ]; then
                      echo "ç­‰å¾… ${wait_time} ç§’åé‡è¯•..."
                      sleep $wait_time
                      wait_time=$((wait_time * 2))
                  fi
                  ((attempt++))
                  return 1
              fi
          fi
        }

        echo "### ğŸ”„ é•œåƒå¤„ç†è¿›åº¦" >> $GITHUB_STEP_SUMMARY
        echo "#### ç™»å½•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        
        # ä½¿ç”¨é‡è¯•å‡½æ•°è¿›è¡Œç™»å½•
        echo "Debug: å°è¯•ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡"
        if docker login -u "$ALIYUN_REGISTRY_USER" -p "$ALIYUN_REGISTRY_PASSWORD" "$ALIYUN_REGISTRY" > /tmp/login.log 2>&1; then
          echo "Debug: Docker ç™»å½•å‘½ä»¤æ‰§è¡Œç»“æœ:"
          cat /tmp/login.log
          if grep -q "Login Succeeded" /tmp/login.log; then
            echo "âœ… é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç™»å½•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "Debug: ç™»å½•æˆåŠŸç¡®è®¤"
          else
            echo "âŒ é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç™»å½•å¤±è´¥: æœªæ‰¾åˆ°æˆåŠŸæ ‡è®°" >> $GITHUB_STEP_SUMMARY
            echo "Debug: ç™»å½•è¾“å‡ºä¸åŒ…å«æˆåŠŸæ ‡è®°"
            exit 1
          fi
        else
          echo "âŒ é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç™»å½•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "Debug: Docker ç™»å½•å‘½ä»¤å¤±è´¥ï¼Œé€€å‡ºä»£ç : $?"
          cat /tmp/login.log
          echo "ERROR_INFO<<EOF" >> $GITHUB_ENV
          echo "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‡­æ®æ˜¯å¦æ­£ç¡®ã€‚é”™è¯¯æ—¥å¿—ï¼š" >> $GITHUB_ENV
          cat /tmp/login.log >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          exit 1
        fi
        
        # åˆå§‹åŒ–é”™è¯¯ä¿¡æ¯æ”¶é›†
        errors=()
        
        # åˆå§‹åŒ–é•œåƒä¿¡æ¯æ”¶é›†æ•°ç»„
        declare -a successful_images=()
        declare -a failed_images_info=()
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºçŠ¶æ€è·Ÿè¸ª
        mkdir -p /tmp/docker_push_status
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "images.txt" ]; then
            echo "Error: images.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
        fi
        
        # æ¸…ç†æ–‡ä»¶æ ¼å¼
        echo "Debug: æ¸…ç†æ–‡ä»¶æ ¼å¼"
        # åˆ é™¤ç©ºè¡Œå’ŒWindowsæ¢è¡Œç¬¦
        sed -i '/^[[:space:]]*$/d' images.txt
        sed -i 's/\r$//' images.txt
        
        # æ˜¾ç¤ºå¤„ç†åçš„æ–‡ä»¶å†…å®¹
        echo "Debug: å¤„ç†åçš„æ–‡ä»¶å†…å®¹:"
        cat -n images.txt
        
        # åˆå§‹åŒ–è®¡æ•°å™¨
        total_images=0
        processed_images=0
        failed_images=0
        
        # è®¡ç®—æ€»é•œåƒæ•°ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
        echo "Debug: å¼€å§‹è®¡ç®—æ€»é•œåƒæ•°"
        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi
            
            echo "Debug: å¤„ç†è¡Œ: '$line'"
            
            # éªŒè¯é•œåƒæ ¼å¼ï¼ˆæ”¹è¿›çš„æ ¼å¼éªŒè¯ï¼‰
            if ! echo "$line" | grep -qE '^([a-zA-Z0-9._-]+/)?[a-zA-Z0-9._-]+(/[a-zA-Z0-9._-]+)?:[a-zA-Z0-9._-]+$'; then
                echo "Error: æ— æ•ˆçš„é•œåƒæ ¼å¼: '$line'"
                echo "é•œåƒæ ¼å¼åº”è¯¥æ˜¯: [registry/][namespace/]name:tag"
                exit 1
            fi
            
            echo "Debug: æœ‰æ•ˆçš„é•œåƒæ ¼å¼: $line"
            
            # åœ¨å¢åŠ è®¡æ•°ä¹‹å‰æ·»åŠ è°ƒè¯•ä¿¡æ¯
            echo "Debug: å½“å‰æ€»æ•°: $total_images"
            # ä¿®æ”¹è®¡æ•°å™¨é€’å¢çš„æ–¹å¼
            total_images=$((total_images + 1))
            if [ $? -ne 0 ]; then
                echo "Error: è®¡æ•°å™¨é€’å¢å¤±è´¥"
                exit 1
            fi
            echo "Debug: æ›´æ–°åæ€»æ•°: $total_images"
            
            # éªŒè¯é•œåƒæ ¼å¼è§£æ
            echo "Debug: å¼€å§‹è§£æé•œåƒæ ¼å¼"
            image_name_tag=$(echo "$line" | awk -F'/' '{print $NF}') || { echo "Error: è§£æé•œåƒåç§°å’Œæ ‡ç­¾å¤±è´¥"; exit 1; }
            echo "Debug: æˆåŠŸè§£æé•œåƒåç§°å’Œæ ‡ç­¾: $image_name_tag"
            
            name_space=$(echo "$line" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}') || { echo "Error: è§£æå‘½åç©ºé—´å¤±è´¥"; exit 1; }
            echo "Debug: æˆåŠŸè§£æå‘½åç©ºé—´: '$name_space'"
            
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            echo "Debug: æˆåŠŸè§£æé•œåƒå: $image_name"
            
            echo "Debug: é•œåƒè§£ææµ‹è¯•å®Œæˆ:"
            echo "- å®Œæ•´é•œåƒ: $line"
            echo "- é•œåƒåç§°å’Œæ ‡ç­¾: $image_name_tag"
            echo "- å‘½åç©ºé—´: $name_space"
            echo "- é•œåƒå: $image_name"
            
            # éªŒè¯è§£æç»“æœ
            if [ -z "$image_name" ]; then
                echo "Error: é•œåƒåä¸ºç©º"
                exit 1
            fi
            if [ -z "$image_name_tag" ]; then
                echo "Error: é•œåƒåç§°å’Œæ ‡ç­¾ä¸ºç©º"
                exit 1
            fi
            
            echo "Debug: è¯¥è¡Œå¤„ç†å®Œæˆ"
        done < images.txt || { echo "Error: æ–‡ä»¶è¯»å–å¤±è´¥"; exit 1; }
        
        echo "Debug: æ–‡ä»¶è¯»å–å®Œæˆ"
        
        # éªŒè¯æ€»é•œåƒæ•°
        echo "Debug: éªŒè¯æ€»é•œåƒæ•°"
        if [ $total_images -eq 0 ]; then
            echo "Error: æœªæ‰¾åˆ°æœ‰æ•ˆçš„é•œåƒé…ç½®"
            exit 1
        fi
        
        echo "Debug: æ‰¾åˆ° $total_images ä¸ªæœ‰æ•ˆé•œåƒ"
        
        # å¯¼å‡ºåˆå§‹ç»Ÿè®¡ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡
        {
            echo "build_start_time=${build_start_time}" >> $GITHUB_ENV
            echo "total_images=${total_images}" >> $GITHUB_ENV
        }
        
        # æ·»åŠ å¤„ç†ç»Ÿè®¡åˆ°æ‘˜è¦
        {
            echo "#### ğŸ“Š å¤„ç†ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- å¾…å¤„ç†é•œåƒæ€»æ•°: ${total_images}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### ğŸ” é•œåƒå¤„ç†è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
            echo "| åºå· | æºé•œåƒ | ç›®æ ‡é•œåƒ | çŠ¶æ€ | è€—æ—¶ | é‡è¯•æ¬¡æ•° |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|-----------|------|------|-----------|" >> $GITHUB_STEP_SUMMARY
        }
        
        # æ•°æ®é¢„å¤„ç†,åˆ¤æ–­é•œåƒæ˜¯å¦é‡å
        declare -A duplicate_images
        declare -A temp_map
        
        echo "Debug: å¼€å§‹é¢„å¤„ç†é•œåƒåç§°æŸ¥é‡"
        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi
            
            # è·å–é•œåƒçš„å®Œæ•´åç§°
            image="$line"  # ç›´æ¥ä½¿ç”¨æ•´è¡Œä½œä¸ºé•œåƒåç§°
            # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
            image="${image%%@*}"
            echo "Debug: å¤„ç†é•œåƒ $image"
            
            # è·å–é•œåƒå:ç‰ˆæœ¬å·
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            echo "Debug: é•œåƒåç§°å’Œæ ‡ç­¾: $image_name_tag"
            
            # è·å–å‘½åç©ºé—´
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
            echo "Debug: å‘½åç©ºé—´: $name_space"
            
            # è¿™é‡Œä¸è¦æ˜¯ç©ºå€¼å½±å“åˆ¤æ–­
            name_space="${name_space}_"
            
            # è·å–é•œåƒå
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            echo "Debug: é•œåƒå: $image_name"
            
            # å¦‚æœé•œåƒå­˜åœ¨äºæ•°ç»„ä¸­ï¼Œåˆ™æ·»åŠ åˆ°temp_map
            if [[ -n "${temp_map[$image_name]}" ]]; then
                # å¦‚æœtemp_mapå·²ç»å­˜åœ¨é•œåƒåï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯åŒä¸€å‘½åç©ºé—´
                if [[ "${temp_map[$image_name]}" != $name_space ]]; then
                    echo "Debug: å‘ç°é‡å¤é•œåƒå: $image_name"
                    duplicate_images[$image_name]="true"
                fi
            else
                # å­˜é•œåƒçš„å‘½åç©ºé—´
                temp_map[$image_name]=$name_space
                echo "Debug: æ·»åŠ æ–°é•œåƒåˆ°temp_map: $image_name -> $name_space"
            fi
        done < images.txt
        
        echo "Debug: å¼€å§‹å¤„ç†é•œåƒ"
        # ç¡®ä¿å˜é‡å’Œæ•°ç»„æ­£ç¡®åˆå§‹åŒ–
        processed_images=0
        failed_images=0
        retry_count=0
        declare -a successful_images=()
        declare -a failed_images_info=()
        
        echo "Debug: åˆå§‹åŒ–å¤„ç†å˜é‡å®Œæˆ"
        echo "Debug: å¼€å§‹é•œåƒå¤„ç†å¾ªç¯"
        
        # ä¸»å¤„ç†å¾ªç¯
        while IFS= read -r line || [ -n "$line" ]; do
            # å¿½ç•¥ç©ºè¡Œä¸æ³¨é‡Š
            [[ -z "$line" ]] && continue
            if echo "$line" | grep -q '^\s*#'; then
                continue
            fi
            
            # åœ¨å¤„ç†å‰å¢åŠ è®¡æ•°
            current_count=$((processed_images + 1))
            echo "Debug: å¼€å§‹å¤„ç†ç¬¬ $current_count/$total_images ä¸ªé•œåƒ"
            
            # è§£æé•œåƒä¿¡æ¯
            image="$line"
            image="${image%%@*}"
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
            tag=$(echo "$image_name_tag" | awk -F':' '{print $2}')
            
            # æ„å»ºç›®æ ‡é•œåƒåç§°
            new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$image_name_tag"
            
            echo "Debug: å¤„ç†é•œåƒ: $line"
            echo "Debug: ç›®æ ‡é•œåƒ: $new_image"
            
            # é¦–å…ˆæ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦å·²å­˜åœ¨è¯¥é•œåƒ
            if check_image_exists "$new_image" "$ALIYUN_REGISTRY" "$ALIYUN_NAME_SPACE" "$image_name" "$tag"; then
                echo "Debug: é•œåƒå·²å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†"
                echo "| ${current_count}/${total_images} | \`${image}\` | \`${new_image}\` | â­ï¸ | 0s | 0 |" >> $GITHUB_STEP_SUMMARY
                ((processed_images++))
                continue
            fi
            
            # å¦‚æœé•œåƒä¸å­˜åœ¨ï¼Œåˆ™æ‹‰å–å’Œæ¨é€
            echo "Debug: é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹å¤„ç†"
            start_time=$(date +%s)
            
            if retry_command "docker pull $line"; then
                echo "Debug: é•œåƒæ‹‰å–æˆåŠŸ: $line"
                
                if retry_command "docker tag $image $new_image && docker push $new_image"; then
                    end_time=$(date +%s)
                    duration=$((end_time - start_time))
                    echo "Debug: æˆåŠŸæ¨é€é•œåƒ: $new_image (è€—æ—¶: ${duration}s)"
                    echo "| ${current_count}/${total_images} | \`${image}\` | \`${new_image}\` | âœ… | ${duration}s | ${retry_count} |" >> $GITHUB_STEP_SUMMARY
                    successful_images+=("âœ… $new_image (è€—æ—¶: ${duration}s)")
                    
                    # æ¸…ç†é•œåƒ
                    docker rmi "$image" "$new_image" || true
                else
                    echo "Debug: é•œåƒæ¨é€å¤±è´¥"
                    ((failed_images++))
                    errors+=("æ¨é€å¤±è´¥: $image -> $new_image")
                    failed_images_info+=("âŒ $image -> $new_image")
                    echo "| ${current_count}/${total_images} | \`${image}\` | \`${new_image}\` | âŒ | - | ${retry_count} |" >> $GITHUB_STEP_SUMMARY
                fi
            else
                echo "Debug: é•œåƒæ‹‰å–å¤±è´¥"
                ((failed_images++))
                errors+=("æ‹‰å–å¤±è´¥: $line")
                failed_images_info+=("âŒ $line")
                echo "| ${current_count}/${total_images} | \`$line\` | - | âŒ | - | ${retry_count} |" >> $GITHUB_STEP_SUMMARY
            fi
            
            ((processed_images++))
            echo "Debug: æ£€æŸ¥ç£ç›˜ç©ºé—´çŠ¶æ€"
            df -hT
            
            echo "Debug: å®Œæˆå¤„ç†é•œåƒ: $line"
            echo "Debug: å½“å‰è¿›åº¦: $processed_images/$total_images"
        done < images.txt
        
        echo "Debug: é•œåƒå¤„ç†å¾ªç¯å®Œæˆ"
        echo "Debug: å¤„ç†ç»“æœç»Ÿè®¡:"
        echo "- æ€»æ•°: $total_images"
        echo "- å·²å¤„ç†: $processed_images"
        echo "- å¤±è´¥: $failed_images"
        
        # æ›´æ–°æœ€ç»ˆç»Ÿè®¡
        build_end_time=$(date +%s)
        total_duration=$((build_end_time - build_start_time))
        
        # è®¡ç®—æˆåŠŸç‡
        if [ $total_images -gt 0 ]; then
          success_rate=$(( (processed_images - failed_images) * 100 / total_images ))
        else
          success_rate=0
        fi
        
        # å¯¼å‡ºç»Ÿè®¡ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡
        {
          echo "success_rate=${success_rate}" >> $GITHUB_ENV
          echo "total_duration=${total_duration}" >> $GITHUB_ENV
          echo "processed_images=${processed_images}" >> $GITHUB_ENV
          echo "failed_images=${failed_images}" >> $GITHUB_ENV
          echo "total_images=${total_images}" >> $GITHUB_ENV
        }
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ“ˆ æœ€ç»ˆç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æˆåŠŸå¤„ç†: $((processed_images - failed_images)) ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- âŒ å¤„ç†å¤±è´¥: ${failed_images} ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š æˆåŠŸç‡: ${success_rate}%" >> $GITHUB_STEP_SUMMARY
        echo "- â±ï¸ æ€»è€—æ—¶: ${total_duration} ç§’" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æœæœ‰é”™è¯¯ï¼Œè®°å½•åˆ°ç¯å¢ƒå˜é‡ä¸­
        if [ ${#errors[@]} -gt 0 ]; then
          echo "ERROR_INFO<<EOF" >> $GITHUB_ENV
          echo "å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š" >> $GITHUB_ENV
          printf '%s\n' "${errors[@]}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi

    - name: Build Summary
      if: always()
      run: |
        if [ -n "${{ env.build_start_time }}" ]; then
          start_time="${{ env.build_start_time }}"
          echo "### ğŸ“‹ æ„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "#### â° æ—¶é—´ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- å¼€å§‹æ—¶é—´: $(date -d "@$start_time" '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»è€—æ—¶: ${{ env.total_duration }} ç§’" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ğŸ“‹ æ„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "#### âš ï¸ æ„å»ºè¿‡ç¨‹ä¸­æ–­" >> $GITHUB_STEP_SUMMARY
          echo "æ„å»ºè¿‡ç¨‹æœªæ­£å¸¸å®Œæˆï¼Œæ— æ³•è·å–å®Œæ•´çš„æ—¶é—´ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ“Š å¤„ç†ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        if [ -n "${{ env.total_images }}" ]; then
          total="${{ env.total_images }}"
          failed="${{ env.failed_images }}"
          success=$((total - failed))
          
          echo "Debug: è®¡ç®—ç»Ÿè®¡ä¿¡æ¯"
          echo "- æ€»æ•°: $total"
          echo "- å¤±è´¥: $failed"
          echo "- æˆåŠŸ: $success"
          
          echo "- æ€»é•œåƒæ•°: $total ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- æˆåŠŸæ•°é‡: $success ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- å¤±è´¥æ•°é‡: $failed ä¸ª" >> $GITHUB_STEP_SUMMARY
          echo "- æˆåŠŸç‡: ${{ env.success_rate }}%" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ æ— å¯ç”¨ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        fi

    # æ·»åŠ é‚®ä»¶é€šçŸ¥åŠŸèƒ½
    - name: Send Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: 'Ali_ACR_Pusher æ„å»ºé€šçŸ¥'
        to: ${{ secrets.GMAIL_USERNAME }}
        from: ${{ secrets.GMAIL_USERNAME }}
        html_body: |
          <h2>ğŸ”” æ„å»ºé€šçŸ¥</h2>
          
          <h3>ğŸ“Š æ„å»ºçŠ¶æ€</h3>
          ${{ job.status == 'success' && 'âœ… æ„å»ºæˆåŠŸ' || 'âŒ æ„å»ºå¤±è´¥' }}
          
          <h3>ğŸ“‹ è¯¦ç»†ä¿¡æ¯</h3>
          <ul>
            <li>ğŸ¢ ä»“åº“ï¼š${{ github.repository }}</li>
            <li>ğŸ”„ è§¦å‘äº‹ä»¶ï¼š${{ github.event_name }}</li>
            <li>ğŸ“ æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}</li>
            <li>ğŸ‘¤ æäº¤è€…ï¼š${{ github.actor }}</li>
            <li>â° å¼€å§‹æ—¶é—´ï¼š$(date -d @${{ env.build_start_time }} '+%Y-%m-%d %H:%M:%S')</li>
            <li>âŒ› æ€»è€—æ—¶ï¼š${{ env.total_duration }} ç§’</li>
            <li>ğŸ“ˆ æˆåŠŸç‡ï¼š${{ env.success_rate }}%</li>
          </ul>

          <h3>ğŸ“Š å¤„ç†ç»Ÿè®¡</h3>
          <ul>
            <li>æ€»é•œåƒæ•°ï¼š${{ env.total_images }} ä¸ª</li>
            <li>æˆåŠŸå¤„ç†ï¼š$((${{ env.total_images }} - ${{ env.failed_images }})) ä¸ª</li>
            <li>å¤„ç†å¤±è´¥ï¼š${{ env.failed_images }} ä¸ª</li>
          </ul>

          <h3>ğŸ³ é•œåƒå¤„ç†ç»“æœ</h3>
          <pre style="background-color: #f6f8fa; padding: 10px; border-radius: 5px;">${{ env.IMAGES_INFO }}</pre>
          
          ${{ env.ERROR_INFO && '<h3>âŒ é”™è¯¯ä¿¡æ¯</h3><pre style="color: #ff0000; background-color: #ffebeb; padding: 10px; border-radius: 5px;">' || '' }}${{ env.ERROR_INFO }}${{ env.ERROR_INFO && '</pre>' || '' }}
          
          <hr>
          <p>ğŸ“Œ æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æ„å»ºæ—¥å¿—</a></p>
          
          <p style="color: #666; font-size: 12px;">æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤ã€‚</p>

    # æ·»åŠ è·å–å½“å‰æ—¶é—´çš„æ­¥éª¤
    - name: Get current time
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    # æ”¶é›†æ¨é€çš„é•œåƒä¿¡æ¯
    - name: Collect Images Info
      if: always()
      run: |
        echo "IMAGES_INFO<<EOF" >> $GITHUB_ENV
        echo "æ¨é€çš„é•œåƒåˆ—è¡¨ï¼š" >> $GITHUB_ENV
        while IFS= read -r line || [ -n "$line" ]; do
          if [[ -n "$line" && ! "$line" =~ ^\s*# ]]; then
            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            echo "âœ“ $image" >> $GITHUB_ENV
          fi
        done < images.txt
        echo "EOF" >> $GITHUB_ENV
