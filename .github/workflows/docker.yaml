name: Pusher

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  schedule:
    - cron: '0 1 * * *'  # æ¯å¤©å‡Œæ™¨ 1 ç‚¹æ‰§è¡Œ


env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_REGISTRY_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_REGISTRY_PASSWORD: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"

jobs:

  build:
    name: Pull
    runs-on: ubuntu-latest
    steps:
    - name: Start Build Process
      run: |
        echo "### ğŸš€ å¼€å§‹æ„å»ºæµç¨‹" >> $GITHUB_STEP_SUMMARY
        echo "#### â° æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- å¼€å§‹æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- è§¦å‘äº‹ä»¶: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰§è¡Œåˆ†æ”¯: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ„å»ºç¼–å·: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY

    - name: System Info Check
      run: |
        echo "### ğŸ’» ç³»ç»Ÿä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "æ“ä½œç³»ç»Ÿ: $(uname -a)" >> $GITHUB_STEP_SUMMARY
        echo "Docker ç‰ˆæœ¬: $(docker --version)" >> $GITHUB_STEP_SUMMARY
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:" >> $GITHUB_STEP_SUMMARY
        df -h | grep -v tmpfs >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Before freeing up disk space
      run: |
        echo "::group::ç£ç›˜ç©ºé—´æ£€æŸ¥ - æ¸…ç†å‰"
        df -hT
        echo "::endgroup::"

    # å¢åŠ å¯ç”¨ç£ç›˜ç©ºé—´
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 2048
        swap-size-mb: 128
        remove-dotnet: 'true'
        remove-haskell: 'true'
        # å¦‚æœç©ºé—´è¿˜æ˜¯ä¸å¤Ÿç”¨ï¼Œå¯ä»¥æŠŠä»¥ä¸‹å¼€å¯ï¼Œæ¸…ç†å‡ºæ›´å¤šç©ºé—´
        # remove-android: 'true'
        # remove-codeql: 'true'
        build-mount-path: '/var/lib/docker/'

    - name: After Space Cleanup
      run: |
        echo "### ğŸ’¾ ç£ç›˜ç©ºé—´ä¼˜åŒ–" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "æ¸…ç†åå¯ç”¨ç©ºé—´:" >> $GITHUB_STEP_SUMMARY
        df -h | grep -v tmpfs >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Restart docker
      run: sudo service docker restart

    - name: Free up disk space complete
      run: |
        echo "Free up disk space complete"
        echo "=============================================================================="
        df -hT
        echo "=============================================================================="

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Docker Setup Buildx
      uses: docker/setup-buildx-action@v3

    # è®°å½•å¼€å§‹æ—¶é—´
    - name: Set start time
      id: start_time
      run: |
        echo "time=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

    - name: Build and push image Aliyun
      id: build_push
      run: |
        # æ·»åŠ è°ƒè¯•ä¿¡æ¯
        echo "Debug: æ˜¾ç¤º images.txt å†…å®¹"
        cat images.txt
        echo "Debug: æ˜¾ç¤ºæ–‡ä»¶ç¼–ç "
        file images.txt
        
        # ç¡®ä¿æ–‡ä»¶ä½¿ç”¨ Unix æ¢è¡Œç¬¦
        dos2unix images.txt || true
        
        # å®šä¹‰é‡è¯•å‡½æ•°
        retry_command() {
          local cmd="$1"
          local max_attempts=3
          local attempt=1
          local wait_time=10
          local error_msg=""
          local retry_count=0
          
          echo "Debug: æ‰§è¡Œå‘½ä»¤: $cmd"
          
          while [ $attempt -le $max_attempts ]; do
            echo "::notice::å°è¯•æ‰§è¡Œå‘½ä»¤ (ç¬¬ $attempt æ¬¡): $cmd"
            if eval "$cmd" 2> >(tee /tmp/error.log >&2); then
              retry_count=$((attempt-1))
              return 0
            else
              error_msg=$(cat /tmp/error.log)
              echo "::warning::å‘½ä»¤æ‰§è¡Œå¤±è´¥ (å°è¯• $attempt/$max_attempts)"
              echo "é”™è¯¯ä¿¡æ¯: $error_msg"
              if [ $attempt -lt $max_attempts ]; then
                echo "ç­‰å¾… ${wait_time} ç§’åé‡è¯•..."
                sleep $wait_time
                wait_time=$((wait_time * 2))
              fi
              ((attempt++))
            fi
          done
          
          retry_count=$((attempt-1))
          echo "::error::å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
          echo "æœ€åä¸€æ¬¡é”™è¯¯ä¿¡æ¯: $error_msg"
          return 1
        }

        echo "### ğŸ”„ é•œåƒå¤„ç†è¿›åº¦" >> $GITHUB_STEP_SUMMARY
        echo "#### ç™»å½•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        
        # ä½¿ç”¨é‡è¯•å‡½æ•°è¿›è¡Œç™»å½•
        if retry_command "docker login -u $ALIYUN_REGISTRY_USER -p $ALIYUN_REGISTRY_PASSWORD $ALIYUN_REGISTRY"; then
          echo "âœ… é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç™»å½•æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ç™»å½•å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "ERROR_INFO<<EOF" >> $GITHUB_ENV
          echo "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥å‡­æ®æ˜¯å¦æ­£ç¡®ã€‚" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          exit 1
        fi
        
        # åˆå§‹åŒ–é”™è¯¯ä¿¡æ¯æ”¶é›†
        errors=()
        
        # åˆå§‹åŒ–é•œåƒä¿¡æ¯æ”¶é›†æ•°ç»„
        declare -a successful_images=()
        declare -a failed_images_info=()
        
        # ä¿®æ”¹æ–‡ä»¶è¯»å–é€»è¾‘
        echo "Debug: å¼€å§‹è¯»å–é•œåƒåˆ—è¡¨"
        total_images=0
        while IFS= read -r line || [ -n "$line" ]; do
          # å»é™¤è¡Œå°¾çš„å›è½¦ç¬¦
          line=$(echo "$line" | tr -d '\r')
          if [[ -n "$line" && ! "$line" =~ ^\s*# ]]; then
            echo "Debug: å‘ç°æœ‰æ•ˆé•œåƒè¡Œ: $line"
            ((total_images++))
          fi
        done < images.txt
        
        echo "Debug: æ€»é•œåƒæ•°: $total_images"
        
        # å¯¼å‡ºæ„å»ºå¼€å§‹æ—¶é—´åˆ°ç¯å¢ƒå˜é‡
        echo "build_start_time=${build_start_time}" >> $GITHUB_ENV
        
        echo "#### ğŸ“Š å¤„ç†ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- å¾…å¤„ç†é•œåƒæ€»æ•°: ${total_images}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "#### ğŸ” é•œåƒå¤„ç†è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        echo "| åºå· | æºé•œåƒ | ç›®æ ‡é•œåƒ | çŠ¶æ€ | è€—æ—¶ | é‡è¯•æ¬¡æ•° |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|-----------|------|------|-----------|" >> $GITHUB_STEP_SUMMARY
        
        while IFS= read -r line || [ -n "$line" ]; do
          if [[ -n "$line" && ! "$line" =~ ^\s*# ]]; then
            ((processed_images++))
            start_time=$(date +%s)
            
            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            
            echo "::group::å¤„ç†é•œåƒ ($processed_images/$total_images): $image"
            
            # ä½¿ç”¨é‡è¯•å‡½æ•°æ‹‰å–é•œåƒ
            if retry_command "docker pull $line"; then
              platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
              platform_prefix="${platform//\//_}_"
              
              # è·å–é•œåƒçš„å®Œæ•´åç§°ï¼Œä¾‹å¦‚kasmweb/nginx:1.25.3ï¼ˆå‘½åç©ºé—´/é•œåƒå:ç‰ˆæœ¬å·ï¼‰
              image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
              # è·å–å‘½åç©ºé—´ ä¾‹å¦‚kasmweb  è¿™é‡Œæœ‰ç§ç‰¹æ®Šæƒ…å†µ docker.io/nginxï¼ŒæŠŠdocker.ioå½“æˆå‘½åç©ºé—´ï¼Œä¹ŸOK
              name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
              # è·å–é•œåƒåä¾‹å¦‚nginx
              image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')
              
              name_space_prefix=""
              # å¦‚æœå‘½åç©ºé—´éç©ºï¼Œå°†å‘½åç©ºé—´åŠ åˆ°å‰ç¼€
              if [[ -n "${name_space}" ]]; then
                name_space_prefix="${name_space}_"
              fi
              
              # å°†@sha256:ç­‰å­—ç¬¦åˆ é™¤
              image_name_tag="${image_name_tag%%@*}"
              new_image="$ALIYUN_REGISTRY/$ALIYUN_NAME_SPACE/$platform_prefix$name_space_prefix$image_name_tag"
              
              # è®¡ç®—æˆåŠŸç‡æ—¶æ·»åŠ é”™è¯¯å¤„ç†
              if [ $total_images -gt 0 ]; then
                success_rate=$(( (total_images - failed_images) * 100 / total_images ))
              else
                success_rate=0
              fi
              
              # ä½¿ç”¨é‡è¯•å‡½æ•°æ ‡è®°å’Œæ¨é€é•œåƒ
              if retry_command "docker tag $image $new_image && docker push $new_image"; then
                retry_count=$retry_count
                end_time=$(date +%s)
                duration=$((end_time - start_time))
                echo "| ${processed_images}/${total_images} | \`${image}\` | \`${new_image}\` | âœ… | ${duration}s | ${retry_count} |" >> $GITHUB_STEP_SUMMARY
                successful_images+=("âœ… $new_image (è€—æ—¶: ${duration}s, é‡è¯•: ${retry_count}æ¬¡)")
              else
                retry_count=$retry_count
                error_msg="æ ‡è®°æˆ–æ¨é€é•œåƒå¤±è´¥"
                errors+=("é•œåƒ $image: $error_msg")
                echo "| ${processed_images}/${total_images} | \`${image}\` | \`${new_image}\` | âŒ | - | ${retry_count} |" >> $GITHUB_STEP_SUMMARY
                failed_images_info+=("âŒ $image -> $new_image (å¤±è´¥åŸå› : $error_msg, é‡è¯•: ${retry_count}æ¬¡)")
              fi
            else
              ((failed_images++))
              error_msg="æ‹‰å–é•œåƒå¤±è´¥"
              errors+=("é•œåƒ $image: $error_msg")
              echo "| ${processed_images}/${total_images} | \`${image}\` | - | âŒ | - | $((attempt-1)) |" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "::endgroup::"
            
            # æ¸…ç†é•œåƒ
            docker rmi $image $new_image 2>/dev/null || true
          fi
        done < images.txt
        
        # æ›´æ–°æœ€ç»ˆç»Ÿè®¡
        build_end_time=$(date +%s)
        total_duration=$((build_end_time - build_start_time))
        
        # è®¡ç®—æˆåŠŸç‡ï¼ˆé¿å…é™¤é›¶é”™è¯¯ï¼‰
        if [ $total_images -gt 0 ]; then
          success_rate=$(( (total_images - failed_images) * 100 / total_images ))
        else
          success_rate=0
        fi
        
        # å¯¼å‡ºç»Ÿè®¡ä¿¡æ¯åˆ°ç¯å¢ƒå˜é‡
        {
          echo "success_rate=${success_rate}" >> $GITHUB_ENV
          echo "total_duration=${total_duration}" >> $GITHUB_ENV
          echo "total_images=${total_images}" >> $GITHUB_ENV
          echo "failed_images=${failed_images}" >> $GITHUB_ENV
        }
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ“ˆ æœ€ç»ˆç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æˆåŠŸå¤„ç†: $((total_images - failed_images)) ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- âŒ å¤„ç†å¤±è´¥: ${failed_images} ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š æˆåŠŸç‡: ${success_rate}%" >> $GITHUB_STEP_SUMMARY
        echo "- â±ï¸ æ€»è€—æ—¶: ${total_duration} ç§’" >> $GITHUB_STEP_SUMMARY
        
        # å¦‚æœæœ‰é”™è¯¯ï¼Œè®°å½•åˆ°ç¯å¢ƒå˜é‡ä¸­
        if [ ${#errors[@]} -gt 0 ]; then
          echo "ERROR_INFO<<EOF" >> $GITHUB_ENV
          echo "å¤„ç†è¿‡ç¨‹ä¸­å‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š" >> $GITHUB_ENV
          printf '%s\n' "${errors[@]}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        fi

    - name: Build Summary
      if: always()
      run: |
        echo "### ğŸ“‹ æ„å»ºå®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "#### â° æ—¶é—´ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- å¼€å§‹æ—¶é—´: $(date -d @${{ env.build_start_time }} '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- ç»“æŸæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- æ€»è€—æ—¶: ${{ env.total_duration }} ç§’" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ“Š å¤„ç†ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "- æ€»é•œåƒæ•°: ${{ env.total_images }} ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- æˆåŠŸæ•°é‡: $((${{ env.total_images }} - ${{ env.failed_images }})) ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- å¤±è´¥æ•°é‡: ${{ env.failed_images }} ä¸ª" >> $GITHUB_STEP_SUMMARY
        echo "- æˆåŠŸç‡: ${{ env.success_rate }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### ğŸ”— ç›¸å…³é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "- [æŸ¥çœ‹ä»£ç å˜æ›´](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY

    # æ·»åŠ é‚®ä»¶é€šçŸ¥åŠŸèƒ½
    - name: Send Notification
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.GMAIL_USERNAME }}
        password: ${{ secrets.GMAIL_PASSWORD }}
        subject: 'Ali_ACR_Pusher æ„å»ºé€šçŸ¥'
        to: ${{ secrets.GMAIL_USERNAME }}
        from: ${{ secrets.GMAIL_USERNAME }}
        html_body: |
          <h2>ğŸ”” æ„å»ºé€šçŸ¥</h2>
          
          <h3>ğŸ“Š æ„å»ºçŠ¶æ€</h3>
          ${{ job.status == 'success' && 'âœ… æ„å»ºæˆåŠŸ' || 'âŒ æ„å»ºå¤±è´¥' }}
          
          <h3>ğŸ“‹ è¯¦ç»†ä¿¡æ¯</h3>
          <ul>
            <li>ğŸ¢ ä»“åº“ï¼š${{ github.repository }}</li>
            <li>ğŸ”„ è§¦å‘äº‹ä»¶ï¼š${{ github.event_name }}</li>
            <li>ğŸ“ æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}</li>
            <li>ğŸ‘¤ æäº¤è€…ï¼š${{ github.actor }}</li>
            <li>â° å¼€å§‹æ—¶é—´ï¼š$(date -d @${{ env.build_start_time }} '+%Y-%m-%d %H:%M:%S')</li>
            <li>âŒ› æ€»è€—æ—¶ï¼š${{ env.total_duration }} ç§’</li>
            <li>ğŸ“ˆ æˆåŠŸç‡ï¼š${{ env.success_rate }}%</li>
          </ul>

          <h3>ğŸ“Š å¤„ç†ç»Ÿè®¡</h3>
          <ul>
            <li>æ€»é•œåƒæ•°ï¼š${{ env.total_images }} ä¸ª</li>
            <li>æˆåŠŸå¤„ç†ï¼š$((${{ env.total_images }} - ${{ env.failed_images }})) ä¸ª</li>
            <li>å¤„ç†å¤±è´¥ï¼š${{ env.failed_images }} ä¸ª</li>
          </ul>

          <h3>ğŸ³ é•œåƒå¤„ç†ç»“æœ</h3>
          <pre style="background-color: #f6f8fa; padding: 10px; border-radius: 5px;">${{ env.IMAGES_INFO }}</pre>
          
          ${{ env.ERROR_INFO && '<h3>âŒ é”™è¯¯ä¿¡æ¯</h3><pre style="color: #ff0000; background-color: #ffebeb; padding: 10px; border-radius: 5px;">' || '' }}${{ env.ERROR_INFO }}${{ env.ERROR_INFO && '</pre>' || '' }}
          
          <hr>
          <p>ğŸ“Œ æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">æ„å»ºæ—¥å¿—</a></p>
          
          <p style="color: #666; font-size: 12px;">æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ï¼Œè¯·å‹¿ç›´æ¥å›å¤ã€‚</p>

    # æ·»åŠ è·å–å½“å‰æ—¶é—´çš„æ­¥éª¤
    - name: Get current time
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

    # æ”¶é›†æ¨é€çš„é•œåƒä¿¡æ¯
    - name: Collect Images Info
      if: always()
      run: |
        echo "IMAGES_INFO<<EOF" >> $GITHUB_ENV
        echo "æ¨é€çš„é•œåƒåˆ—è¡¨ï¼š" >> $GITHUB_ENV
        while IFS= read -r line || [ -n "$line" ]; do
          if [[ -n "$line" && ! "$line" =~ ^\s*# ]]; then
            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            echo "âœ“ $image" >> $GITHUB_ENV
          fi
        done < images.txt
        echo "EOF" >> $GITHUB_ENV
